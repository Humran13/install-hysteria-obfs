#!/bin/bash

set -e

echo "🚀 Starting Hysteria 2 VPN Automated Installer (with Obfuscation)..."

# === Variables ===
HYSTERIA_VERSION="v2.1.5"
BINARY_URL="https://github.com/apernet/hysteria/releases/latest/download/hysteria-linux-amd64"
INSTALL_PATH="/usr/local/bin/hysteria"
CONFIG_DIR="/etc/hysteria"
CONFIG_FILE="${CONFIG_DIR}/config.yaml"
PORT=443
OBFS_PASS=$(openssl rand -hex 8)
CERT_PATH="/etc/ssl/certs/hysteria.crt"
KEY_PATH="/etc/ssl/private/hysteria.key"
AUTH_PASSWORD=$(openssl rand -hex 6)

# === Check root ===
if [[ $EUID -ne 0 ]]; then
  echo "❌ Please run as root"
  exit 1
fi

# === Install dependencies ===
apt update && apt install -y curl wget openssl sudo

# === Download binary ===
echo "⬇️ Downloading Hysteria binary..."
curl -L -o "$INSTALL_PATH" "$BINARY_URL"
chmod +x "$INSTALL_PATH"

# === Create config directory ===
mkdir -p "$CONFIG_DIR"

# === Generate self-signed cert ===
echo "🔐 Generating self-signed TLS certificate..."
openssl req -x509 -newkey rsa:2048 -nodes -keyout "$KEY_PATH" -out "$CERT_PATH" -days 365 \
  -subj "/CN=HysteriaVPN"

# === Create config file ===
cat > "$CONFIG_FILE" <<EOF
listen: :$PORT
tls:
  cert: $CERT_PATH
  key: $KEY_PATH
auth:
  type: password
  password: "$AUTH_PASSWORD"
obfs:
  type: salamander
  password: "$OBFS_PASS"
masquerade:
  type: proxy
  proxy:
    url: https://www.google.com
    rewriteHost: true
EOF

# === Systemd service ===
cat > /etc/systemd/system/hysteria.service <<EOF
[Unit]
Description=Hysteria 2 VPN Server
After=network.target

[Service]
ExecStart=$INSTALL_PATH server -c $CONFIG_FILE
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# === Enable and start service ===
systemctl daemon-reexec
systemctl daemon-reload
systemctl enable hysteria
systemctl restart hysteria

# === Get server IP ===
IP=$(curl -s ipv4.icanhazip.com)

# === Output config URI ===
echo -e "\n✅ Hysteria 2 Installed and Running!"
echo -e "📱 Use this link in HTTP Injector or any Android client:\n"
echo "hysteria2://$AUTH_PASSWORD@$IP:$PORT/?obfs-password=$OBFS_PASS&insecure=1"

echo -e "\n✅ Configuration saved at: $CONFIG_FILE"
